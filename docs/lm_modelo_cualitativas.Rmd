---
title: "Regresores cualitativos"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
  pdf_document:
    number_sections: true
    toc: true
---


# Regresores cualitativos con dos niveles

Las variables cualitativas se representan en R con *factores*. En este caso hay dos variables cualitativas, *mom_hs* y *mom_work*, que ya son factores:

```{r}
load("datos/kidiq.Rdata")
str(d)
```

## Variables auxiliares

La primera opción para incluir regresores cualitativos en el modelo es crear variables auxiliares con valores cero - uno. En este caso se crea la variable auxiliar *secundaria_si*:

- secundaria_si = 1, si la madre ha terminado secundaria (mom_hs = si)
- secundaria_si = 0, si la madre no ha terminado secundaria (mom_hs = no)

```{r}
secundaria_si = ifelse(d$mom_hs == "si", 1, 0)
```

El modelo estadístico que vamos a estimar es:

$$
kid\_score_i = \beta_0 + \beta_1 mom\_iq_i + \beta_2 secundaria\_si_i + u_i
$$

```{r}
m = lm(kid_score ~ mom_iq + secundaria_si, data = d)
coef(m)
```

El el fondo tenemos dos modelos, uno para las madres que han terminado secundaria y otro para los que no han terminado:

- Madres sin secundaria terminada (variable secundaria_si = 0): El modelo correspondiente es

$$
kid\_score_i = \beta_0 + \beta_1 mom\_iq_i + u_i
$$

- Madres con secundaria terminada (variable secundaria_si = 1): el modelo correspondiente es

$$
kid\_score_i = (\beta_0 + \beta_2) + \beta_1 mom\_iq_i + u_i
$$

Es decir, son dos rectas paralelas de pendiente $\beta_1$ y separadas una distancia igual a $\beta_2$.

```{r}
plot(d$mom_iq, d$kid_score)
# modelo para secundaria_si = 0
abline(a = m$coef[1], b = m$coef[2], col = "blue")
# modelo para secundaria_si = 1
abline(a = m$coef[1] + m$coef[3], b = m$coef[2], col = "red")
```


## Factores

Una manera más elegante de estimar estos modelos en R es utilizar directamente los factores en la formula de lm():

```{r}
m = lm(kid_score ~ mom_iq + mom_hs, data = d)
summary(m)
```

Internamente, R ha creado la variable auxiliar *mom_hssi*, que toma los valores

- mom_hssi = 1 si mom_hs = si
- mom_hssi = 0 si mom_hs = no.

R asigna los valores 0 y 1 en función de los niveles del factor:

```{r}
levels(d$mom_hs)
```

```{r}
contrasts(d$mom_hs)
```

## Variables auxiliares 1

También se podía haber creado la variable auxiliar *secundaria_no*:

- secundaria_no = 0, si la madre ha terminado secundaria (mom_iq = si)
- secundaria_no = 1, si la madre no ha terminado secundaria (mom_iq = no)

```{r}
secundaria_no = ifelse(d$mom_hs == "no", 1, 0)
```

El modelo estadístico que vamos a estimar ahora es:

$$
kid\_score_i = \beta_0^* + \beta_1^* mom\_iq_i + \beta_2^* secundaria\_no_i + u_i
$$
  
donde se ha enfatizado que, en principio, los parámetros son diferentes ya que las variables son diferentes. En R:
  
```{r}
m = lm(kid_score ~ mom_iq + secundaria_no, data = d)
coef(m)
```

Los dos modelos que tenemos ahora son:

- Madres sin secundaria terminada (variable secundaria_no = 1): el modelo correspondiente es

$$
kid\_score_i = (\beta_0^* + \beta_2^*) + \beta_1^* mom\_iq_i + u_i
$$

- Madres con secundaria terminada (variable secundaria_no = 0): El modelo correspondiente es

$$
kid\_score_i = \beta_0^* + \beta_1^* mom\_iq_i + u_i
$$

Igualando los modelos creados con las dos variables auxiliares, se tiene que cumplir que:

$$
\beta_1 = \beta_1^*
$$

$$
\beta_0 = \beta_0^* + \beta_2^*
$$

$$
\beta_0^* = \beta_0 + \beta_2
$$

Eliminando $\beta_0^*$ se tiene que

$$
\beta_2 = -\beta_2^*
$$

## Factores 1

Este nuevo modelo se introduce en lm() cambiando el nivel de referencia de la variable factor. Los niveles que tiene actualmente la variable son

```{r}
levels(d$mom_hs)
```

EL nivel de referencia es "no". Los valores que R asigna internamente a cada nivel son

```{r}
contrasts(d$mom_hs)
```

Cambiamos el nivel de referencia:

```{r}
d$mom_hs1 = relevel(d$mom_hs, ref = "si")
levels(d$mom_hs1)
```

Por tanto, los valores que asigna R a los distintos niveles son

```{r}
contrasts(d$mom_hs1)
```

Ahora se puede aplicar la función lm():

```{r}
m = lm(kid_score ~ mom_iq + mom_hs1, data = d)
summary(m)
```

Vemos que ahora R ha creado la variable auxiliar *mom_hsno*, que toma los valores

- mom_hsno = 0 si mom_hs = si
- mom_hsno = 1 si mom_hs = no.

## Modelo sin ordenada en el origen

Una tercera opción es utilizar el modelo sin ordenada en el origen:

$$
kid\_score =  \beta_1 mom\_iq + \beta_2 secundaria\_si + \beta_3 secundaria\_no + u
$$

en el que se utilizan las dos variables auxiliares pero se elimina el parámetro $\beta_0$. Los modelos ahora son:

- madre que si ha terminado secundaria: secundaria_si = 1, secundaria_no = 0

$$
kid\_score = \beta_2 + \beta_1 mom\_iq + u
$$

- madre que no ha terminado secundaria: secundaria_si = 0, secundaria_no = 1

$$
kid\_score = \beta_3 + \beta_1 mom\_iq + u
$$

De nuevo tenemos dos rectas paralelas con pendiente $\beta_1$ y separadas una distancia igual a $\beta_2 - \beta_3$.

```{r}
m = lm(kid_score ~ 0 + mom_iq + secundaria_si + secundaria_no, data = d)
summary(m)
```

Con factores:

```{r}
m = lm(kid_score ~ 0 + mom_iq + mom_hs, data = d)
summary(m)
```

# Regresores cualitativos con más de dos niveles

## Variables auxiliares

En el caso de tener regresores cualitativos con más de dos niveles:

```{r}
levels(d$mom_work)
```

Se definen las variables auxiliares:

```{r}
notrabaja_si = ifelse(d$mom_work == "notrabaja", 1, 0)
trabaja23_si = ifelse(d$mom_work == "trabaja23", 1, 0)
trabaja1p_si = ifelse(d$mom_work == "trabaja1p", 1, 0)
trabaja1c_si = ifelse(d$mom_work == "trabaja1c", 1, 0)
```

Como la variable cualitativa tiene **cuatro niveles**, con **tres variables auxiliares** representamos todos los casos. El modelo general es:

$$
kid\_score = \beta_0 + \beta_1 mom\_iq + \beta_2 trabaja23\_si + \beta_3 trabaja1p\_si + \beta_4 trabaja1c\_si + u
$$

- El modelo para las madres que no han trabajado es

$$
kid\_score = \beta_0 + \beta_1 mom\_iq + u
$$

ya que en este caso trabaja23_si = 0, trabaja1p_si = 0 y trabaja1c_si = 0. 

- El modelo para las madres que trabajaron el segundo o tercer año es:

$$
kid\_score = (\beta_0 + \beta_2) + \beta_1 mom\_iq + u
$$

- El modelo para las madres que trabajaron el primer año a tiempo parcial es:

$$
kid\_score = (\beta_0 + \beta_3) + \beta_1 mom\_iq + u
$$

- Por último, el modelo para las madres que trabajaron el primer año a tiempo completo es:

$$
kid\_score = (\beta_0 + \beta_4) + \beta_1 mom\_iq + u
$$

En R:

```{r}
m = lm(kid_score ~ mom_iq + trabaja23_si + trabaja1p_si + trabaja1c_si, data = d)
summary(m)
```

* Es decir, tenemos cuatro rectas paralelas con pendiente $\beta_1$. 
* $\beta_2$ representa la distancia entre el modelo para las madres que trabajaron el segundo o tercer año y el modelo para las madres que no han trabajado (la referencia en este caso).
* $\beta_3$ representa la distancia entre el modelo para las madres que trabajaron el primer año a tiempo parcial y el modelo para las madres que no han trabajado.
* $\beta_4$ representa la distancia entre el modelo para las madres que trabajaron el primer año a tiempo completo y el modelo para las madres que no han trabajado.

## Factores

Utilizando factores se obtienen los mismos resultados:

```{r}
m = lm(kid_score ~ mom_iq + mom_work, data = d)
summary(m)
```

Comprobamos que internamente R crea variables auxiliares según los valores:

```{r}
levels(d$mom_work)
```

```{r}
contrasts(d$mom_work)
```

Podemos hacer otras comparaciones cambiando la variable de referencia:

```{r}
d$mom_work = relevel(d$mom_work, ref="trabaja1p")
levels(d$mom_work)
```

```{r}
m = lm(kid_score ~ mom_iq + mom_work, data = d)
summary(m)
```

Como observamos, el nivel de referencia, que en este caso es "trabaja1p", no aparece explícitamente en el modelo. Efectivamente, el modelo sería:

$$
kid\_score = \beta_0^* + \beta_1^* mom\_iq + \beta_2^* notrabaja\_si + \beta_3^* trabaja23\_si + \beta_4^* trabaja1c\_si + u
$$

El caso de la variable trabaja1p aparece cuando el resto de variables toma el valor cero. En ese caso el modelos sería:

$$
kid\_score = \beta_0^* + \beta_1^* mom\_iq + u
$$

Además de cambiar el nivel de referencia, también se podría reordenar los niveles de la variable factor:

```{r}
d$mom_work1 = factor(d$mom_work, levels=c("trabaja1c","trabaja23","notrabaja","trabaja1p"))
levels(d$mom_work1)
```

```{r}
m = lm(kid_score ~ mom_work1, data = d)
summary(m)
```

Como vemos de nuevo, el nivel de referencia no aparece explícitamente.

# Modelo con más de un regresor cualitativo

# Modelo con interacción entre regresores cuantitativos y cualitativos

## Variables auxiliares

En los modelos anteriores se ha modelado las variables cuantitativas y cualitativas por separado, obteniendo rectas paralelas. También es posible incluir la interacción de ambas variables, es decir, el comportamiento de una variable influye en la otra variable. El modelo se escribe así:

$$
kid\_score = \beta_0 + \beta_1 mom\_iq  + \beta_2 secundaria\_si + \beta_3 secundaria\_si * mom\_iq + u
$$

Como vemos, este modelo incluye dos submodelos:

- si la madre no ha terminado secundaria *secundaria_si = 0*: $kid\_score = \beta_0 + \beta_1 mom\_iq + e$

- si la madre si ha terminado secundaria *secundaria_si = 1*: $kid\_score = (\beta_0 + \beta_2) + (\beta_1 + \beta_3) mom\_iq  + e$

Luego tenemos dos modelos con ordenadas en el origen y pendiente diferentes. En R introducimos la interacción haciendo:

```{r}
m = lm(kid_score ~ mom_iq + secundaria_si + I(mom_iq*secundaria_si), data = d)
summary(m)
```

Gráficamente:

```{r}
plot(d$mom_iq, d$kid_score, col = d$mom_hs, pch = 20)
abline(a = m$coefficients["(Intercept)"], b = m$coefficients["mom_iq"], col = "black")
abline(a = m$coefficients["(Intercept)"] + m$coefficients["secundaria_si"],
       b = m$coefficients["mom_iq"] + m$coefficients["I(mom_iq * secundaria_si)"], col = "red")
```

En este modelo, la diferencia entre puntuaciones medias de chicos no es constante como antes, depende simultáneamente del valor de mom_iq de su madre y de si terminó o no la secundaria.

## Factores

Con factores, la interacción entre variables se incluye con los dos puntos:

```{r}
m = lm(kid_score ~ mom_iq + mom_hs + mom_iq:mom_hs, data = d)
summary(m)
```

Otra alternativa es utilizar el signo de multiplicación, que incluye los regresores por separado y la interacción:

```{r}
m = lm(kid_score ~ mom_iq * mom_hs, data = d)
summary(m)
```
